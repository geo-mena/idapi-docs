---
title: Onboarding Flow
---

## Overview

This guide covers the complete onboarding flow for new user registration. The process validates identity documents, captures biometric data, and performs liveness detection to create secure digital identities.

## Prerequisites

Before implementing the Onboarding flow, ensure:

1. Integration with SelphID Mobile Widget for document capture `tokenOcr`
2. Integration with Selphi Mobile/Web widgets for biometric capture `imageBuffer`, `bestImageToken`
3. Proper API key configuration and permissions
4. Secure storage infrastructure for biometric templates

## API Configuration

### Base Configuration

| Parameter | Value |
|-----------|--------|
| Host | https://api.identity-platform.io |
| BasePath | /services |

### Required Headers

| Header | Value | Usage |
|--------|-------|-------|
| x-api-key | [Your API Key] | **Required** for all requests |
| family | "OnBoarding" | **Required** when using tracking objects |
| Content-Type | application/json | **Required** for POST requests |

## Onboarding Flow Diagram

<Mermaid
  chart="
sequenceDiagram
    participant U as User/Client
    participant OCR as Document OCR API
    participant OB as Onboarding API
    participant TRK as Tracking API

    Note over U,TRK: USER ONBOARDING FLOW

    U->>OCR: POST /services/extractDocumentData Mobile or Web
    Note over OCR: Extract document information<br/>Parse identity data
    OCR-->>U: Response Body
    Note over U: Validate extracted data<br/>within serviceDocument

    U->>OB: POST /services/evaluatePassiveLivenessToken
    Note over OB: Validate user liveness<br/>Check if real person
    OB-->>U: Response Body
    Note over U: Continue if:<br/>serviceResultLog = 'Live' OR<br/>serviceLivenessResult = 3

    U->>OB: POST /services/authenticateFacial
    Note over OB: Compare document photo<br/>with user selfie
    OB-->>U: Response Body
    Note over U: Continue if:<br/>serviceResultLog = 'Positive' OR<br/>serviceFacialAuthenticationResult = 3

    U->>TRK: POST /services/finishTracking
    Note over TRK: Complete onboarding<br/>tracking (family: OnBoarding)
    TRK-->>U: Response Body
"
/>

## Implementation Steps

### 1. Document Data Extraction

**Endpoint:** [`/services/extractDocumentData`](/docs/services/ocr/extractDocumentData)

Extract structured data from identity documents using OCR technology.

**Required Parameters:**
- `tokenOcr`: Token generated by the native or hybrid SelphID widget, AES256 encrypted and tokenized, sent in Base64 format. Contains the OCR result from the document capture
- `tracking`: Object that represents necessary tracking information

**Request Example:**
```bash
curl --location '{IDENTITY_API_BASE_URL}/services/extractDocumentData' \
--header 'x-api-key: {API_KEY}' \
--header 'Content-Type: application/json' \
--data '{
    "tokenOcr": "BAMBAQLNHJoWGPjfeuDIzDXdZuP...",
    "tracking": {
        "extraData": "BQABAQG2gBNjuHN4kLmPqYf7R...",
        "operationId": "123e4567-e89b-12d3-a456-426614174000"
    }
}'
```

**Response Example:**
```json
{
  "serviceResultCode": 0,
  "serviceResultLog": "Service request successfully processed",
  "serviceTime": "19",
  "serviceDocument": "{\"DocumentNumber\":\"987654321\",\"FirstName\":\"JOHN\",\"LastName\":\"DOE\",\"DateOfBirth\":\"01/01/1980\",\"DateOfExpiry\":\"01/01/2030\",\"Nationality\":\"USA\"}", // [!code highlight]
  "serviceTransactionId": "123e4567-e89b-12d3-a456-426614174000"
}
```

### 2. Passive Liveness Evaluation

**Endpoint:** [`/services/evaluatePassiveLivenessToken`](/docs/services/onboarding/evaluatePassiveLivenessToken)

This service performs a liveness check using the best tokenized image obtained during the user's selfie capture.

**Required Parameters:**
- `imageBuffer`: BestImage property generated by the Selphi widget and tokenized using the widget's native function
- `tracking`: Object that represents necessary tracking information

**Required Header:** `family: "OnBoarding"` when using tracking fields

**Request Example:**
```bash
curl --location '{IDENTITY_API_BASE_URL}/services/evaluatePassiveLivenessToken' \
--header 'x-api-key: {API_KEY}' \
--header 'family: OnBoarding' \
--header 'Content-Type: application/json' \
--data '{
    "imageBuffer": "BAMBAQLNHJoWGPjfeuDIzDXdZuP...",
    "tracking": {
        "extraData": "BQABAQG2gBNjuHN4kLmPqYf7R...",
        "operationId": "123e4567-e89b-12d3-a456-426614174000"
    }
}'
```

**Response Example:**
```json
{
  "serviceResultCode": 0,
  "serviceResultLog": "Live", // [!code highlight]
  "serviceTime": "799",
  "serviceTransactionId": "35d93da8-b843-4033-8e78-c0aabedcef8b",
  "serviceLivenessResult": 3 // [!code highlight]
}
```

### 3. Facial Authentication

**Endpoint:** [`/services/authenticateFacial`](/docs/services/onboarding/authenticateFacial)

Service that performs facial validation between two faces, including both open images and biometric templates.

**Required Parameters:**
- `token1`: Image used as reference for facial comparison. Depending on the method invoked, it can be the token generated by the SelphID widgets (document photo token), an open image, or a tokenized biometric template
- `token2`: Image used for the comparison. It can be an open image or a tokenized biometric template
- `method`: Indicates the comparison method invoked (1-5, [see documentation](/docs/services/onboarding/authenticateFacial) for method specifications)
- `tracking`: Object that represents necessary tracking information

**Required Header:** `family: "OnBoarding"` when using tracking fields

**Request Example:**
```bash
curl --location '{IDENTITY_API_BASE_URL}/services/authenticateFacial' \
--header 'x-api-key: {API_KEY}' \
--header 'family: OnBoarding' \
--header 'Content-Type: application/json' \
--data '{
    "token1": "BAMBAQLNHJoWGPjfeuDIzDXdZuP...",
    "token2": "BAMBAQLNHJoWGPjfeuDIzDXdZuP...",
    "method": 1,
    "tracking": {
        "extraData": "BQABAQG2gBNjuHN4kLmPqYf7R...",
        "operationId": "123e4567-e89b-12d3-a456-426614174000"
    }
}'
```

**Response Example:**
```json
{
  "serviceResultCode": 0,
  "serviceResultLog": "Positive", // [!code highlight]
  "serviceTime": "516",
  "serviceTransactionId": "a29cbe15-2b68-495f-b7eb-be985b21c486",
  "serviceFacialAuthenticationResult": 3, // [!code highlight]
  "serviceFacialSimilarityResult": 0.99153554
}
```

### 4. Complete Onboarding Tracking Process

**Endpoint:** [`/services/finishTracking`](/docs/services/tracking/finishTracking)

Finalize the onboarding tracking process to ensure proper monitoring and audit trail.

**Required Parameters:**
- `family`: Possible values: "Authentication", "OnBoarding"
- `status`: Possible values: "SUCCEEDED", "DENIED", "ERROR", "CANCELLED", "BLACKLISTED"
- `reason`: Possible values include "MANUAL_STATUS_CHANGE", "FACIAL_AUTHENTICATION_NOT_PASSED", "FACIAL_LIVENESS_NOT_PASSED", etc.
- `extraData`: Token generated by Mobile/Web SDK. Contains tokenized tracking information

**Request Example:**
```bash
curl --location '{IDENTITY_API_BASE_URL}/services/finishTracking' \
--header 'x-api-key: {API_KEY}' \
--header 'Content-Type: application/json' \
--data '{
    "family": "OnBoarding",
    "status": "SUCCEEDED",
    "reason": "MANUAL_STATUS_CHANGE",
    "extraData": "BQABAQG2gBNjuHN4kLmPqYf7R..."
}'
```

**Response Example:**
```json
{
  "trackingStatus": 201, // [!code highlight]
  "trackingMessage": "FinishTrackingEvent: Ok",
  "transactionId": "123e4567-e89b-12d3-a456-426614174000",
  "timestamp": "2023-05-01T12:34:56.789Z"
}
```

## Response Codes and Status

### Service Result Codes

| serviceResultCode | Description | HTTP code |
|---|---|---|
| 0 | The service execution was successful, the module processed the request correctly. | 200 |

### Service Facial Authentication Result

| Code | Result | Description |
|---|---|---|
| 0 | NONE | Facial verification could not be performed. |
| 1 | NEGATIVE | The process was successfully executed. The facial pattern comparison of the faces does not match. |
| 3 | POSITIVE | The process was successfully executed. The facial pattern comparison of the faces is positive. The value of serviceFacialSimilarityResult indicates the % of similarity between the compared images. |
| 4 | NONE BECAUSE POSE EXCEED | Facial verification could not be performed due to face pose. |
| 5 | NONE BECAUSE INVALID EXTRACTIONS | Facial verification could not be performed due to issues in facial pattern extraction. |

### Service Liveness Result

| Code | Result | Description |
|---|---|---|
| 0 | None | Liveness check could not be evaluated. |
| 3 | Live | The subject is assumed to be alive. |
| 4 | NoneBecauseBadQuality | Liveness check could not be evaluated due to poor image quality. |
| 5 | NoneBecauseFaceTooClose | Liveness check could not be evaluated because faces were detected too close to the edges. |
| 6 | NoneBecauseFaceNotFound | Liveness check could not be evaluated because no faces were detected. |
| 7 | NoneBecauseFaceTooSmall | Liveness check could not be evaluated because faces detected were too small. |
| 8 | NoneBecauseAngleTooLarge | Liveness check could not be evaluated because the angle between faces exceeded the allowed limit. |
| 17 | NoLive | No liveness detected. |
| 18 | NoneBecauseEyesClosed | Liveness check could not be evaluated because the person's eyes are closed. |

### HTTP Error Codes

| HTTP Code | Content-type | Description |
|---|---|---|
| 400 | application/json | Request validation failed. Check that all required parameters are included and properly formatted. |
| 401 | application/json | Authentication failed. Verify your API key is correct and included in the x-api-key header. |
| 403 | application/json | API key is valid but lacks permission for this resource. Contact support to verify your access level. |
| 502 | application/json | Internal service communication error. Contact support@facephi.com if this error persists. |
| 504 | application/json | Request processing timeout. Contact support@facephi.com if this error persists. |

## Related Documentation

- [Document Data Extraction Service](/docs/services/ocr/extractDocumentData) - Detailed OCR API reference
- [Passive Liveness Evaluation Service](/docs/services/onboarding/evaluatePassiveLivenessToken) - Liveness detection reference
- [Facial Authentication Service](/docs/services/onboarding/authenticateFacial) - Biometric comparison reference
- [Tracking Services](/docs/services/tracking) - Complete tracking reference
- [Service Result Codes](/docs/services/serviceResultCodes) - Error code reference
- [Authentication Integration Flow](/docs/references/authentication) - Post-onboarding user verification
