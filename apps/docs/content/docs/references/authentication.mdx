---
title: Authentication Flow
---

## Overview

This guide covers user authentication for previously registered users. The process compares stored biometric templates with live captures to validate user identity and detect liveness.

## Prerequisites

Before implementing the Authentication flow, ensure:

1. Users have completed the onboarding process
2. Biometric templates `registeredTemplateRaw` are securely stored
3. Unique `userId` identifiers are maintained
4. Integration with Selphi Mobile/Web widgets for capturing `bestImageToken`

## API Configuration

### Base Configuration

| Parameter | Value |
|-----------|--------|
| Host | https://api.identity-platform.io |
| BasePath | /services |

### Required Headers

| Header | Value | Usage |
|--------|-------|-------|
| x-api-key | [Your API Key] | Required for all requests |
| family | "Authentication" | Required when using tracking objects |
| Content-Type | application/json | Required for POST requests |

## Authentication Flow Diagram

<Mermaid
  chart="
sequenceDiagram
    participant U as User/Client
    participant AUTH as Authentication API
    participant TRK as Tracking API

    Note over U,TRK: USER AUTHENTICATION FLOW

    U->>AUTH: POST /services/authenticateUser
    Note over AUTH: Compare stored template<br/>with current capture<br/>Validate liveness
    AUTH-->>U: Authentication result + similarity

    U->>TRK: POST /services/finishTracking
    Note over TRK: Complete authentication<br/>tracking (family: Authentication)
    TRK-->>U: trackingStatus + completion
"
/>

## Implementation Steps

### 1. User Authentication

**Endpoint:** [`/services/authenticateUser`](/docs/services/authentication/authenticateUser)

This service validates both liveness and facial authentication. It compares the biometric template (templateRaw), which was previously validated and stored in the client's data repository during the Onboarding process, with a bestImageToken generated at the time of authentication.

**Required Parameters:**
- `userId`: Unique identifier for the user. Must be persisted and associated with the corresponding biometric template. Needs to be at least two digits
- `registeredTemplateRaw` OR `image`: Template generated by the Selphi widget, AES256 encrypted and tokenized, sent in Base64 format. Represents the user's facial pattern with the most frontal face pose detected OR Base64 formatted image obtained from the civil registry for authentication
- `bestImageToken` OR `template`: Tokenized bestImage property generated by the Selphi widget at the time of authentication OR Base64 formatted biometric template
- `merchantReferenceId`: Client reference for each authentication. It is recommended that this data does not contain sensitive information such as PII (personally identifiable information)

**Request Example:**
```bash
curl --location '{IDENTITY_API_BASE_URL}/services/authenticateUser' \
--header 'x-api-key: {API_KEY}' \
--header 'family: Authentication' \
--header 'Content-Type: application/json' \
--data '{
    "userId": "001",
    "registeredTemplateRaw": "BAIBAQFpWLJtBYBymCoRF...",
    "bestImageToken": "BAIBAQIJTHP8obR2r9ALdDtR5lT...",
    "merchantReferenceId": "auth-session-001",
    "tracking": {
        "extraData": "BQABAQG2gBNjuHN4kLmPqYf7R...",
        "operationId": "123e4567-e89b-12d3-a456-426614174000"
    }
}'
```

**Response Example:**
```json
{
    "merchantReferenceId": "auth-session-001",
    "serviceResultCode": 0,
    "serviceResultLog": "",
    "serviceFacialSimilarityResult": 0.9946970343589783,
    "timestamp": "2024-10-29T20:29:24Z",
    "transactionId": "531ecbb1-de3d-4907-a737-0db236674e9a",
    "registeredTemplateRaw": "BAIBAQGo+puJyHjfRD8n"
}
```

**Alternative Authentication Using Civil Registry Image:**

When biometric templates are not available, authentication can be performed using civil registry images:

```bash
curl --location '{IDENTITY_API_BASE_URL}/services/authenticateUser' \
--header 'x-api-key: {API_KEY}' \
--header 'family: Authentication' \
--header 'Content-Type: application/json' \
--data '{
    "userId": "001",
    "image": "/9j/4AAQSkZJRgABAQAASABIAAD...",
    "bestImageToken": "BAIBAQIJTHP8obR2r9ALdDtR5lT...",
    "merchantReferenceId": "auth-civil-001",
    "tracking": {
        "extraData": "BQABAQG2gBNjuHN4kLmPqYf7R...",
        "operationId": "123e4567-e89b-12d3-a456-426614174000"
    }
}'
```

### 2. Complete Authentication Tracking

**Endpoint:** [`/services/finishTracking`](/docs/services/tracking/finishTracking)

Finalize the authentication tracking process to ensure proper monitoring and audit trail.

**Required Parameters:**
- `family`: Possible values: "Authentication", "OnBoarding"
- `status`: Possible values: "SUCCEEDED", "DENIED", "ERROR", "CANCELLED", "BLACKLISTED"
- `reason`: Possible values include "MANUAL_STATUS_CHANGE", "FACIAL_AUTHENTICATION_NOT_PASSED", "FACIAL_LIVENESS_NOT_PASSED", etc.
- `extraData`: Token generated by Mobile/Web SDK. Contains tokenized tracking information

**Request Example:**
```bash
curl --location '{IDENTITY_API_BASE_URL}/services/finishTracking' \
--header 'x-api-key: {API_KEY}' \
--header 'Content-Type: application/json' \
--data '{
    "family": "Authentication",
    "status": "SUCCEEDED",
    "reason": "MANUAL_STATUS_CHANGE",
    "extraData": "BQABAQG2gBNjuHN4kLmPqYf7R..."
}'
```

**Response Example:**
```json
{
    "trackingStatus": 201,
    "trackingMessage": "FinishTrackingEvent: Ok",
    "transactionId": "123e4567-e89b-12d3-a456-426614174000",
    "timestamp": "2023-05-01T12:34:56.789Z"
}
```

## Response Codes and Status

### Service Result Codes

| serviceResultCode | Description | HTTP code |
|---|---|---|
| 0 | The service execution was successful, the module processed the request correctly. | 200 |

### Service Result Code Authenticate User

| serviceResultCode | Description | HTTP code |
|---|---|---|
| 0 | User authenticated successfully. | 200 |
| -100 | The registeredTemplateRaw parameter does not match the ID: [XXX] | 200 |
| -101 | The bestImageToken parameter does not match a living person. | 200 |
| -102 | User authentication failed due to non-matching templateRaw. | 200 |

### Service Facial Authentication Result

| Code | Result | Description |
|---|---|---|
| 0 | NONE | Facial verification could not be performed. |
| 1 | NEGATIVE | The process was successfully executed. The facial pattern comparison of the faces does not match. |
| 3 | POSITIVE | The process was successfully executed. The facial pattern comparison of the faces is positive. The value of serviceFacialSimilarityResult indicates the % of similarity between the compared images. |
| 4 | NONE BECAUSE POSE EXCEED | Facial verification could not be performed due to face pose. |
| 5 | NONE BECAUSE INVALID EXTRACTIONS | Facial verification could not be performed due to issues in facial pattern extraction. |

### Service Liveness Result

| Code | Result | Description |
|---|---|---|
| 0 | None | Liveness check could not be evaluated. |
| 3 | Live | The subject is assumed to be alive. |
| 17 | NoLive | No liveness detected. |

### Tracking Status Codes

| Status | Description |
|--------|-------------|
| SUCCEEDED | Authentication completed successfully |
| DENIED | Authentication failed |
| ERROR | Technical error occurred |
| CANCELLED | Process was cancelled |

### Tracking Reason Codes

| Reason | Description |
|--------|-------------|
| MANUAL_STATUS_CHANGE | Manual completion |
| FACIAL_AUTHENTICATION_NOT_PASSED | Biometric comparison failed |
| FACIAL_LIVENESS_NOT_PASSED | Liveness detection failed |
| FACIAL_AUTHENTICATION_ERROR | Technical authentication error |
| FACIAL_LIVENESS_ERROR | Technical liveness error |

### HTTP Error Codes

| HTTP Code | Content-type | Description |
|---|---|---|
| 400 | application/json | Request validation failed. Check that all required parameters are included and properly formatted. |
| 401 | application/json | Authentication failed. Verify your API key is correct and included in the x-api-key header. |
| 403 | application/json | API key is valid but lacks permission for this resource. Contact support to verify your access level. |
| 502 | application/json | Internal service communication error. Contact support@facephi.com if this error persists. |
| 504 | application/json | Request processing timeout. Contact support@facephi.com if this error persists. |

## Related Documentation

- [User Authentication Service](/docs/services/authentication/authenticateUser) - Detailed API reference
- [Authentication V2 Service](/docs/services/authentication/authenticateUserV2) - Enhanced version with additional features
- [Update User Template](/docs/services/authentication/updateUserTemplate) - Template management
- [Delete Users](/docs/services/authentication/deleteUsers) - User cleanup operations
- [Tracking Services](/docs/services/tracking) - Complete tracking reference
- [Service Result Codes](/docs/services/serviceResultCodes) - Error code reference
- [Onboarding Integration Flow](/docs/references/index) - Initial user registration process